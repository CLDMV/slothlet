# Slothlet v2.11.0 Changelog

**Release Date**: TBD

## Overview

Version 2.11.0 introduces critical fixes for addApi content preservation and enhanced smart flattening behaviors. This release focuses on robust merging when multiple addApi calls target the same API path, along with comprehensive development tooling improvements.

## âœ¨ New Features

### Rule 11: AddApi Special File Pattern

**Feature**: Files named `addapi.mjs` loaded via `addApi()` method now automatically flatten regardless of `autoFlatten` setting, designed for seamless API namespace extensions.

**Use Cases**:

- ðŸ”Œ **Plugin Systems**: Runtime plugin loading and API extension
- ðŸ”„ **Hot Reloading**: Dynamic API updates during development
- ðŸ“¦ **Modular Extensions**: Clean extension of existing API surfaces
- ðŸŽ¯ **Targeted Integration**: Specific API namespace enhancement

**Example**:

```javascript
// File: plugins/addapi.mjs
export function initializePlugin() {
	/* ... */
}
export function cleanup() {
	/* ... */
}
export function configure() {
	/* ... */
}

// API Usage:
await api.addApi("plugins", "./plugin-folder");

// Result: Always flattened (no .addapi. level)
api.plugins.initializePlugin(); // âœ… Direct extension of plugins namespace
api.plugins.cleanup(); // âœ… Seamless API extension
api.plugins.configure(); // âœ… No intermediate nesting
```

**Technical Details**:

- Special case handling in `addApiFromFolder()` for addapi.mjs files
- Automatic flattening independent of `autoFlatten` configuration
- Enables clean plugin architecture with predictable structure
- Test coverage in `api_tests/api_smart_flatten_addapi/`

**Related Documentation**: [API-RULES.md Rule 11](../API-RULES.md#rule-11-addapi-special-file-pattern), [API-FLATTENING-v2.md F06](../API-FLATTENING-v2.md#f06-addapi-special-file-pattern)

### Rule 1 Extended to AddApi Context

**Feature**: Filename-matches-container flattening (Rule 1) now works with `addApi()` runtime extensions, preventing redundant nesting in dynamically loaded modules.

**Behavior**: When folder name matches filename in addApi context, content automatically flattens to category level.

**Example**:

```javascript
// File structure:
// plugins/
//   plugins.mjs  <- filename matches folder name
//     export function load() { /* ... */ }
//     export function unload() { /* ... */ }

// Without Rule 1 extension:
await api.addApi("plugins", "./plugins");
api.plugins.plugins.load(); // âŒ Redundant nesting

// With Rule 1 extension:
await api.addApi("plugins", "./plugins");
api.plugins.load(); // âœ… Clean flattening
api.plugins.unload(); // âœ… Direct access to category level
```

**Technical Details**:

- Extended `getFlatteningDecision()` to recognize container-matching in addApi context
- Consistent behavior between initial load and addApi operations
- Works in both eager and lazy loading modes
- Prevents common pitfall of redundant nesting (api.plugins.plugins.method)

**Related Documentation**: [API-RULES.md Rule 1](../API-RULES.md#rule-1-filename-matches-container-flattening), [API-FLATTENING-v2.md F01](../API-FLATTENING-v2.md#f01-folder-file-name-matching)

## ðŸ› Critical Bug Fixes

### Fixed addApi Multiple Calls Content Preservation

**Issue**: Multiple `addApi()` calls targeting the same API path were overwriting previous content instead of properly merging, causing loss of previously loaded functions.

**Root Cause**: Lazy mode module loading was corrupting bound API state before content preservation could occur, leading to incomplete merges.

**Solution**: Implemented super early content capture and object reference isolation:

```javascript
// Before: Second call would overwrite first call's content
await api.addApi("config", "./config-basic"); // Loads basic config functions
await api.addApi("config", "./config-advanced"); // âŒ Overwrote basic functions

// After: Both calls merge correctly
await api.addApi("config", "./config-basic"); // Loads basic config functions
await api.addApi("config", "./config-advanced"); // âœ… Merges with basic functions
// Result: All functions from both directories available at api.config.*
```

**Technical Details**:

- Added early content capture before module loading in lazy mode
- Implemented object reference isolation to prevent contamination during merge operations
- Enhanced merge logic in `decisions.mjs` to properly combine objects instead of overwriting
- Both lazy and eager modes now have consistent behavior for multi-call scenarios

### Enhanced Rule 12: addApi Smart Flattening

**Issue**: Smart flattening behavior for addApi operations lacked comprehensive handling of complex folder structures and edge cases.

**Solution**: Implemented robust Rule 12 validation and enhanced flattening logic:

- âœ… Comprehensive test coverage with 168 test scenarios passing
- âœ… Enhanced handling of filename-matches-folder-name scenarios (Rule 1 compliance)
- âœ… Improved `autoFlatten=false` behavior understanding that Rule 1 applies regardless
- âœ… Added lazy mode materialization support with `isValidFolderType()` helper
- âœ… Fixed lazy mode `typeof` assertions to accept functions as valid folder types

## ðŸ› ï¸ Development Experience Improvements

### Enhanced Test Suite for Smart Flattening

**New Comprehensive Testing**:

- **168 test scenarios** covering all flattening edge cases
- **Cross-mode validation** ensuring lazy/eager mode consistency
- **Runtime compatibility** across async/live runtimes and hook configurations
- **Materialization testing** for lazy mode function type validation

**Test File Enhancements**:

```javascript
// Enhanced test expectations for Rule 1 flattening
// config/config.mjs scenarios now properly expect flattening at root level
// services/services/services.mjs tests validate proper Rule 1 behavior
// autoFlatten=false tests confirm Rule 1 applies regardless of setting
```

### API Documentation Suite Overhaul

**Comprehensive Documentation Updates**:

- **Enhanced API-FLATTENING.md** with 3-tier navigation system (F01-F07 patterns)
- **Updated API-RULES.md** with verified examples and cross-references (Rules 1-12)
- **Corrected API-RULES-CONDITIONS.md** with accurate source code verification (C01-C18)
- **Added complete cross-reference system** linking all documentation levels
- **Verified all technical details** against current source code implementation

### Build and Development Tooling

**Improved Development Workflow**:

- Enhanced error handling in merge operations
- Better debugging output for flattening decisions
- Streamlined test isolation and cleanup procedures
- More reliable validation across different runtime modes

## ðŸ”§ Internal Improvements

### addApi Merge Algorithm Enhancement

**Enhanced Content Preservation**:

```javascript
// New super early capture mechanism in lazy mode
const existingContent = this.getCaptureContent(targetPath);

// Enhanced merge logic in decisions.mjs
const mergedContent = Object.assign(
	{},
	existingContent, // Preserve existing
	newContent // Add new content
);
```

### Smart Flattening Rule Enforcement

**Rule 1 Compliance**:

- Filename-matches-folder-name scenarios consistently flatten regardless of `autoFlatten` setting
- Enhanced validation for nested folder structures
- Improved materialization triggers in lazy mode

## ðŸ“¦ Files Changed

### Core Framework Files

- `src/lib/helpers/api_builder/add_api.mjs` - Content preservation and merge logic
- `src/lib/helpers/api_builder/decisions.mjs` - Enhanced merge algorithm
- `src/lib/modes/slothlet_lazy.mjs` - Early content capture and materialization
- `src/lib/modes/slothlet_eager.mjs` - Consistent merge behavior

### Test and Validation Files

- `tests/test-smart-flattening-api.mjs` - Comprehensive 168-scenario test suite
- Multiple API test modules for various flattening scenarios
- Enhanced validation across lazy/eager modes and runtime configurations

### Documentation Files

- `docs/API-FLATTENING.md` - Enhanced user guide with 3-tier navigation
- `docs/API-RULES.md` - Updated with verified examples and cross-references
- `docs/API-RULES-CONDITIONS.md` - Corrected technical implementation details

## ðŸš€ Migration Guide

### For Existing Users

**Enhanced Reliability**: No breaking changes, but much more reliable behavior:

```javascript
// Your existing multi-addApi patterns now work reliably
const api = await slothlet({ dir: "./api" });
await api.addApi("config", "./basic-config");
await api.addApi("config", "./advanced-config");
// âœ… All functions from both directories now properly available
```

**Smart Flattening**: More predictable flattening behavior:

```javascript
// Rule 1 now consistently enforced regardless of autoFlatten setting
// config/config.mjs will always flatten to api.config (not api.config.config)
```

### For Contributors

**Enhanced Testing**: All changes must pass comprehensive 168-scenario test suite:

```cmd
npm run test:smart-flattening  # Validates all flattening behaviors
npm run precommit             # Full validation pipeline
```

## âš¡ Performance Impact

- **addApi Operations**: Minimal overhead from content preservation logic
- **Lazy Mode**: Improved materialization triggers reduce repeated operations
- **Test Suite**: Comprehensive validation ensures no performance regression
- **Overall**: Better reliability with equivalent performance characteristics

## ðŸ”— Related Documentation

- [API Flattening Guide](../API-FLATTENING.md) - Enhanced 3-tier navigation system
- [API Rules Documentation](../API-RULES.md) - Complete behavior catalog with verified examples
- [API Rules Conditions](../API-RULES-CONDITIONS.md) - Technical implementation details

---

**Full Changelog**: [v2.10.0...v2.11.0](https://github.com/cldmv/slothlet/compare/v2.10.0...v2.11.0)
