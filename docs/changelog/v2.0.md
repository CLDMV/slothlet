# Slothlet v2.0.0 Changelog

**Release Date**: September 9, 2025

## Overview

Version 2.0.0 represents a complete architectural rewrite transforming slothlet from a simple module loader into a sophisticated enterprise-grade framework with dual runtime systems, universal module support, and revolutionary copy-left materialization.

## üéØ Complete Architectural Rewrite

### Universal Module Support

Seamless ESM and CommonJS interoperability with zero configuration:

**Key Features:**

- Load `.mjs` and `.cjs` files in the same API
- Bidirectional communication between ESM and CJS modules
- Automatic module type detection
- Zero configuration required

**Example:**

```javascript
// api/esm-module.mjs
import { self } from "@cldmv/slothlet/runtime";
export function esmFunction() {
	return self.cjsModule.process(); // ESM ‚Üí CJS
}

// api/cjs-module.cjs
const { self } = require("@cldmv/slothlet/runtime");
function cjsFunction() {
	return self.esmModule.transform(); // CJS ‚Üí ESM
}
module.exports = { cjsFunction };
```

### Dual Runtime System

Choose between two context isolation approaches:

**AsyncLocalStorage Runtime (default):**

- Modern context isolation using Node.js AsyncLocalStorage
- Requires Node.js v16.4.0+
- Production-ready and recommended
- Import: `@cldmv/slothlet/runtime/async`

**Live-Bindings Runtime:**

- Instance-based live binding system
- Requires Node.js v16.4.0+ (uses AsyncLocalStorage as fallback)
- Alternative execution model
- Import: `@cldmv/slothlet/runtime/live`

**Configuration:**

```javascript
// AsyncLocalStorage (default)
const api = await slothlet({
	dir: "./api",
	runtime: "async",
	context: { user: "alice" }
});

// Live bindings
const api = await slothlet({
	dir: "./api",
	runtime: "live",
	context: { user: "bob" }
});
```

### Copy-Left Materialization

Revolutionary lazy loading with persistent materialization:

**How It Works:**

1. **On-Demand Loading**: Modules load only when first accessed
2. **Copy-Left Persistence**: Once materialized, stays materialized
3. **No Re-Processing**: Zero overhead on subsequent calls
4. **Near-Eager Performance**: Post-materialization approaches eager mode speed

**Performance Benefits:**

- **4.3x Faster Startup**: 564.17Œºs vs 2.45ms in eager mode
- **Minimal Materialization Cost**: ~310Œºs one-time overhead
- **Memory Efficient**: Only loads what you use
- **Scalable**: Perfect for large APIs with sparse usage

### Modular Architecture

Complete code reorganization into logical subsystems:

```plaintext
src/
‚îú‚îÄ‚îÄ slothlet.mjs              # Main orchestrator
‚îî‚îÄ‚îÄ lib/
    ‚îú‚îÄ‚îÄ engine/               # Experimental execution modes
    ‚îú‚îÄ‚îÄ modes/                # Lazy/eager loading strategies
    ‚îÇ   ‚îú‚îÄ‚îÄ slothlet_lazy.mjs
    ‚îÇ   ‚îî‚îÄ‚îÄ slothlet_eager.mjs
    ‚îú‚îÄ‚îÄ runtime/              # Context and binding systems
    ‚îÇ   ‚îî‚îÄ‚îÄ runtime.mjs
    ‚îî‚îÄ‚îÄ helpers/              # Utilities and transformations
        ‚îú‚îÄ‚îÄ api_builder/      # API construction logic
        ‚îú‚îÄ‚îÄ multidefault.mjs  # Multi-default handling
        ‚îî‚îÄ‚îÄ sanitize.mjs      # Filename transformations
```

## üîß Enhanced Features

### AsyncLocalStorage Context Isolation

Per-instance context with automatic propagation:

```javascript
import { self, context, reference } from "@cldmv/slothlet/runtime";

export function processRequest() {
	console.log(`User: ${context.user}`);
	console.log(`Session: ${context.session}`);
	return self.database.query();
}
```

### Smart API Flattening

Five comprehensive flattening rules for intuitive APIs:

1. **Folder/File Matching**: `math/math.mjs` ‚Üí `api.math`
2. **Index Files**: `utils/index.mjs` ‚Üí `api.utils`
3. **Single Named Export**: `config.mjs` with `export const config` ‚Üí `api.config`
4. **Default Export Matching**: File name matches default function ‚Üí flatten
5. **Root-Level Defaults**: Single file with root default ‚Üí `api()`

### Reference Object Support

Merge external objects into API root:

```javascript
const shared = {
	config: { timeout: 5000 },
	utils: { format: (x) => x }
};

const api = await slothlet({
	dir: "./api",
	reference: shared
});

// Access merged properties:
api.config.timeout; // 5000
api.utils.format("test");
```

## ‚ö° Performance Characteristics

### Benchmark Results

**Lazy Mode:**

- Startup: 564.17Œºs (4.3x faster)
- First call: ~310Œºs materialization
- Subsequent calls: Near eager performance

**Eager Mode:**

- Startup: 2.45ms (full load)
- All calls: Optimal performance

### When to Use Each Mode

**Use Lazy When:**

- Large API surface with sparse usage
- Fast startup is critical
- Memory efficiency matters
- Development/testing cycles

**Use Eager When:**

- Consistent low-latency required
- Small to medium API size
- Production performance critical
- Predictable load patterns

## üõ†Ô∏è Breaking Changes

### Runtime System Changes

**Old (v1.x):**

```javascript
import { api } from "./instance.mjs";
export function doWork() {
	return api.helper.process();
}
```

**New (v2.0):**

```javascript
import { self } from "@cldmv/slothlet/runtime";
export function doWork() {
	return self.helper.process();
}
```

### Module Resolution

V2.0 uses conditional exports for proper ESM/CJS support:

```json
{
	"exports": {
		".": {
			"import": "./index.mjs",
			"require": "./index.cjs"
		},
		"./runtime": {
			"import": "./src/lib/runtime/runtime.mjs"
		}
	}
}
```

## üìö New Documentation

### Comprehensive Guides

- **README.md**: Complete feature overview with examples
- **API.md**: Full API reference with detailed parameters
- **Performance Benchmarks**: Detailed comparative analysis
- **Module Structure Guide**: Organization patterns

### Test Infrastructure

Extensive test coverage:

- `api_tests/api_test/` - ESM test modules
- `api_tests/api_test_cjs/` - CommonJS tests
- `api_tests/api_test_mixed/` - Mixed module tests
- Performance benchmarks
- Debug utilities

## Migration Guide

### Upgrading from v1.x

1. **Update imports:**

   ```javascript
   // Old
   import { api } from "./instance.mjs";

   // New
   import { self } from "@cldmv/slothlet/runtime";
   ```

2. **Update configuration:**

   ```javascript
   // Old
   const api = await slothlet({ folder: "./api" });

   // New
   const api = await slothlet({ dir: "./api" });
   ```

3. **Choose runtime:**
   ```javascript
   const api = await slothlet({
   	dir: "./api",
   	runtime: "async", // or "live"
   	context: {
   		/* your context */
   	}
   });
   ```

## Technical Details

### Runtime Resolution

Both runtimes provide identical exports:

```javascript
export const self = /* API proxy */;
export const context = /* User context */;
export const reference = /* Merged references */;
```

### Copy-Left Implementation

Lazy mode uses intelligent proxy chains:

```javascript
// First access: Materializes and replaces proxy
api.math.add(2, 3); // ~310Œºs (materialize + execute)

// Subsequent access: Direct function call
api.math.add(4, 5); // ~0.9Œºs (no materialization)
```

### Context Propagation

AsyncLocalStorage ensures context flows through:

- Synchronous calls
- Promises and async/await
- Event emitters
- Timers and setImmediate
- Third-party async libraries

## Related Documentation

- [Performance Analysis](../PERFORMANCE.md) - Detailed benchmarks
- [API Flattening Rules](../API-FLATTENING.md) - Transformation patterns
- [Module Structure](../MODULE-STRUCTURE.md) - Organization guide
- [Contributing](../../CONTRIBUTING.md) - Development guide

---

**Full Changelog**: https://github.com/CLDMV/slothlet/compare/v1.0.0...v2.0.0
