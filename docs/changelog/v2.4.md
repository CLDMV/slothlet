# Slothlet v2.4.0 Changelog

**Release Date**: October 23, 2025

## Overview

Version 2.4.0 introduces intelligent multi-default export handling that dramatically improves developer experience for multi-file namespaces. When multiple files in the same folder export default functions, slothlet now uses intuitive file names as API keys instead of potentially confusing function names.

## âœ¨ New Features

### Multi-Default Export Handling

Automatic file-name-based API keys for folders with multiple default exports:

**Before v2.4.0:**

```javascript
// api/remote/key.mjs
export default function sendKey(code) { ... }

// api/remote/power.mjs
export default function toggle() { ... }

// api/remote/volume.mjs
export default function setVolume(level) { ... }

// API access was confusing:
api.remote.sendKey()    // âŒ Which file is this from?
api.remote.toggle()     // âŒ Not intuitive
api.remote.setVolume()  // âŒ Doesn't match file structure
```

**After v2.4.0:**

```javascript
// Same module files, better API:
api.remote.key(); // âœ… Matches key.mjs
api.remote.power(); // âœ… Matches power.mjs
api.remote.volume(); // âœ… Matches volume.mjs

// Named exports still accessible:
api.remote.key.press();
api.remote.key.release();
api.remote.power.on();
api.remote.power.off();
```

### Intelligent Detection

Multi-default detection only activates when:

1. Multiple files in the same folder export default functions
2. No mixed export patterns (pure default exports)
3. Function-based defaults (not objects or primitives)

### Backward Compatibility

Preserves existing behavior for:

- **Single default exports** - Function name still used
- **Mixed exports** - Named exports take precedence
- **Object exports** - Object structure maintained
- **Existing APIs** - Zero breaking changes

## ðŸŽ¯ Developer Experience Improvements

### Logical File-Based Naming

API structure now mirrors file organization:

```text
api/
â”œâ”€â”€ multi_defaults/
â”‚   â”œâ”€â”€ key.mjs      â†’ api.multi_defaults.key()
â”‚   â”œâ”€â”€ power.mjs    â†’ api.multi_defaults.power()
â”‚   â””â”€â”€ volume.mjs   â†’ api.multi_defaults.volume()
```

### Eliminates Function Name Ambiguity

No need to remember arbitrary function names in multi-file namespaces:

```javascript
// Old way (pre-v2.4):
// "What was the function name in power.mjs again?"
api.remote.toggle();
api.remote.powerToggle();
api.remote.switchPower(); // â“ Which one is it?

// New way (v2.4+):
// "It's in power.mjs, so it's api.remote.power()"
api.remote.power(); // âœ… Obvious and consistent
```

## ðŸ”§ Technical Implementation

### Multi-Default Detection

Enhanced `_buildCategory` method with intelligent file analysis:

```javascript
const hasMultipleDefaultExports =
	files.filter((file) => {
		const exports = analyzeModule(file);
		return exports.hasDefaultExport && !exports.hasNamedExports;
	}).length > 1;

if (hasMultipleDefaultExports) {
	// Use filename as API key
	apiKey = sanitizeFilename(filename);
} else {
	// Use function name (existing behavior)
	apiKey = defaultExport.name || sanitizeFilename(filename);
}
```

### Works Across All Modes

- **Eager mode**: Immediate detection and correct key assignment
- **Lazy mode**: Proper materialization with file-based keys
- **AsyncLocalStorage runtime**: Full context isolation maintained
- **Live-bindings runtime**: Complete compatibility

## ðŸ§ª Testing Infrastructure

Comprehensive test modules added:

```text
api_tests/api_test/multi_defaults/
â”œâ”€â”€ key.mjs     - Default export with named properties
â”œâ”€â”€ power.mjs   - Default export with on/off methods
â””â”€â”€ volume.mjs  - Default export with up/down/mute methods
```

Debug script enhancements:

- Multi-default function testing
- Lazy mode materialization validation
- API structure consistency verification

## ðŸ“Š Real-World Examples

### Remote Control API

```javascript
// api/remote/key.mjs
export default function key(code) {
	return `Sending key: ${code}`;
}
key.press = (code) => `Pressing ${code}`;
key.release = (code) => `Releasing ${code}`;

// api/remote/power.mjs
export default function power(state) {
	return `Power: ${state}`;
}
power.on = () => "Powering on";
power.off = () => "Powering off";

// api/remote/volume.mjs
export default function volume(level) {
	return `Volume: ${level}`;
}
volume.up = () => "Volume up";
volume.down = () => "Volume down";
volume.mute = () => "Muted";

// Usage - intuitive and matches file structure:
api.remote.key("ENTER")
api.remote.key.press("HOME")
api.remote.power("on")
api.remote.power.off()
api.remote.volume(50)
api.remote.volume.mute()
```

### Device Control API

```javascript
// api/device/connect.mjs
export default function connect(ip) { ... }

// api/device/disconnect.mjs
export default function disconnect() { ... }

// api/device/status.mjs
export default function status() { ... }

// Logical API:
api.device.connect("192.168.1.100")
api.device.disconnect()
api.device.status()
```

## âš¡ Performance Impact

- **Detection overhead**: Negligible - analysis happens once during API construction
- **Runtime performance**: Zero impact after initialization
- **Lazy mode**: Copy-left materialization preserved with proper proxy handling
- **Memory usage**: No additional memory overhead

## Breaking Changes

None - this is a pure enhancement. All existing APIs maintain their current behavior:

- Single default exports continue using function names
- Mixed export patterns unchanged
- Object exports unaffected
- Named-only exports work as before

## Migration Guide

### Upgrading from v2.3.x

No code changes required. Multi-default handling activates automatically when applicable.

### Taking Advantage of Multi-Default

Structure your multi-file namespaces for better APIs:

```javascript
// Before: Mixed approach (still works)
api/
â”œâ”€â”€ remote/
â”‚   â”œâ”€â”€ index.mjs      â†’ api.remote (object with methods)
â”‚   â””â”€â”€ utils.mjs      â†’ api.remote.utils

// After: Multi-default approach (better DX)
api/
â”œâ”€â”€ remote/
â”‚   â”œâ”€â”€ key.mjs        â†’ api.remote.key()
â”‚   â”œâ”€â”€ power.mjs      â†’ api.remote.power()
â”‚   â””â”€â”€ volume.mjs     â†’ api.remote.volume()
```

## Tools Added

### API Structure Inspection

New `tools/inspect-api-structure.mjs` utility:

- Visualizes complete API structure
- Shows multi-default detection
- Validates lazy/eager consistency
- Generates 281-line comprehensive analysis

## Related Documentation

- [Multi-Default Export Patterns](../MODULE-STRUCTURE.md#multi-default-exports) - Complete guide
- [API Flattening Rules](../API-FLATTENING.md) - Rule 4 updated
- [v2.3 Changelog](v2.3.md) - Context propagation features

## Patch Releases

### v2.4.1

- Fixed root-level multi-default exports bug
- Enhanced error handling for edge cases

### v2.4.2

- Replaced hardcoded filename logic with contextual detection
- Fixed connection.mjs export flattening behavior

### v2.4.3

- Fixed self-referential default export handling
- Eliminated config double nesting issues

---

**Full Changelog**: https://github.com/CLDMV/slothlet/compare/v2.3.0...v2.4.0
