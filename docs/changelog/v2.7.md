# Slothlet v2.7.0 Changelog

**Release Date**: December 20, 2025

## Overview

Version 2.7.0 introduces the comprehensive Hook System - a powerful function interception framework with 4 hook types, pattern matching, error source tracking, and runtime management. This major feature enables sophisticated monitoring, caching, validation, and transformation patterns.

## ðŸŽ£ Hook System

### Four Hook Types

Complete interception lifecycle with specialized hooks:

**Before Hooks** - Pre-execution interception:

```javascript
api.hooks.on(
	"validate-input",
	"before",
	({ path, args }) => {
		console.log(`Calling ${path} with:`, args);
		return [args[0] * 2, args[1] * 2]; // Modify arguments
	},
	{ pattern: "math.add", priority: 100 }
);
```

**After Hooks** - Post-execution transformation:

```javascript
api.hooks.on(
	"format-output",
	"after",
	({ path, result }) => {
		console.log(`${path} returned:`, result);
		return result * 10; // Transform result
	},
	{ pattern: "math.*", priority: 100 }
);
```

**Always Hooks** - Final observation with full context:

```javascript
api.hooks.on(
	"log-execution",
	"always",
	({ path, result, hasError, errors }) => {
		if (hasError) {
			console.log(`${path} failed with ${errors.length} error(s)`);
		} else {
			console.log(`${path} succeeded:`, result);
		}
	},
	{ pattern: "**" }
);
```

**Error Hooks** - Error monitoring with source tracking:

```javascript
api.hooks.on(
	"error-logger",
	"error",
	({ path, error, source }) => {
		console.error(`Error in ${path}: ${error.message}`);
		console.error(`Source: ${source.type}`); // 'before' | 'function' | 'after' | 'always'
		if (source.hookId) {
			console.error(`Hook: ${source.hookTag}`);
		}
	},
	{ pattern: "**" }
);
```

### Pattern Matching

Powerful glob-based path filtering:

```javascript
// Exact match
api.hooks.on("id", "before", handler, { pattern: "math.add" });

// Namespace wildcard
api.hooks.on("id", "after", handler, { pattern: "math.*" });

// Function wildcard
api.hooks.on("id", "before", handler, { pattern: "*.add" });

// Global wildcard
api.hooks.on("id", "always", handler, { pattern: "**" });

// Brace expansion
api.hooks.on("id", "after", handler, { pattern: "math.{add,subtract}" });

// Negation
api.hooks.on("id", "before", handler, { pattern: "!internal.*" });
```

### Priority-Based Execution

Control hook execution order with numeric priorities:

```javascript
// Higher priority executes first
api.hooks.on("first", "before", handler1, { priority: 100 });
api.hooks.on("second", "before", handler2, { priority: 50 });
api.hooks.on("third", "before", handler3, { priority: 10 });

// Execution order: first â†’ second â†’ third
```

### Short-Circuit Support

Cancel execution and return custom values from before hooks:

```javascript
api.hooks.on(
	"cache-check",
	"before",
	({ path, args }) => {
		const cached = cache.get(`${path}:${JSON.stringify(args)}`);
		if (cached) {
			return { shortCircuit: true, value: cached };
		}
	},
	{ pattern: "**", priority: 100 }
);

// If cache hit, function never executes
// After hooks skipped on short-circuit
// Always hooks still execute
```

### Error Source Tracking

Detailed error context showing exact origin:

```javascript
api.hooks.on("monitor", "error", ({ error, source }) => {
	console.log(`Error type: ${source.type}`);
	// Possible values:
	// - 'before': Error in before hook
	// - 'function': Error in actual function
	// - 'after': Error in after hook
	// - 'always': Error in always hook
	// - 'unknown': Couldn't determine source

	if (source.hookId) {
		console.log(`Hook ID: ${source.hookId}`);
		console.log(`Hook tag: ${source.hookTag}`);
		console.log(`Timestamp: ${source.timestamp}`);
	}
});
```

### Error Suppression

Control whether errors throw or are observed silently:

```javascript
const api = await slothlet({
	dir: "./api",
	hooks: {
		enabled: true,
		suppressErrors: true // Errors logged but not thrown
	}
});

// Or per-hook:
api.hooks.on("resilient", "error", handler, {
	pattern: "**",
	suppressErrors: true
});
```

## ðŸ”§ Configuration

### Enable Hooks

Multiple ways to enable the hook system:

```javascript
// Enable with defaults
const api = await slothlet({
	dir: "./api",
	hooks: true
});

// Enable with pattern
const api = await slothlet({
	dir: "./api",
	hooks: "math.*"
});

// Enable with full configuration
const api = await slothlet({
	dir: "./api",
	hooks: {
		enabled: true,
		pattern: "**",
		suppressErrors: false
	}
});
```

### Runtime Management

Control hooks at runtime:

```javascript
// Enable/disable globally
api.hooks.enable();
api.hooks.disable();

// List hooks
api.hooks.list(); // All hooks
api.hooks.list("before"); // Only before hooks

// Remove hooks
api.hooks.off("hook-id"); // Remove specific hook
api.hooks.off("math.*"); // Remove by pattern

// Clear hooks
api.hooks.clear(); // Clear all hooks
api.hooks.clear("before"); // Clear only before hooks
```

## ðŸ› ï¸ Technical Implementation

### WeakSet Error Tracking

Replaced error object mutation with WeakSet for immutability:

```javascript
const processedErrors = new WeakSet();

function trackError(error) {
	if (!processedErrors.has(error)) {
		processedErrors.add(error);
		// Process error
	}
}
```

**Benefits:**

- No mutation of frozen/sealed errors
- Compatible with third-party errors
- Proper garbage collection
- Cross-realm safety

### Always Hook Enhanced Context

Full execution context including error information:

```javascript
api.hooks.on(
	"unified-logger",
	"always",
	({
		path, // Function path
		args, // Original arguments
		result, // Final result (if successful)
		hasError, // Boolean indicating errors
		errors // Array of errors (empty if none)
	}) => {
		if (hasError) {
			console.error(`${path} failed:`, errors);
		} else {
			console.log(`${path} succeeded:`, result);
		}
	}
);
```

### Pattern Compilation

Efficient glob pattern matching:

```javascript
// Converts glob patterns to regex
"math.*" â†’ /^math\.[^.]+$/
"**.add" â†’ /^.*\.add$/
"math.{add,sub}" â†’ /^math\.(add|sub)$/
"!internal.*" â†’ Negation filter

// Maximum nesting depth protection
// Supports brace expansion
// Handles special characters
```

### Cross-Mode Compatibility

Identical behavior across all 4 combinations:

- âœ… Eager + AsyncLocalStorage
- âœ… Eager + Live-bindings
- âœ… Lazy + AsyncLocalStorage
- âœ… Lazy + Live-bindings

## ðŸ§ª Testing

Comprehensive test suite with 40+ tests:

**Test Files:**

- `test-hooks-comprehensive.mjs` - 1079 lines, exhaustive scenarios
- `test-hooks-execution.mjs` - 708 lines, execution behavior
- `test-hooks-error-source.mjs` - 425 lines, error tracking
- `test-hooks-always-error-context.mjs` - 347 lines, always hook context
- `test-hooks-internal-properties.mjs` - 348 lines, property protection
- `test-hooks-patterns.mjs` - Pattern matching tests
- `test-hooks-suppress-errors.mjs` - Error suppression tests

## ðŸ“š Use Cases

### Caching Pattern

```javascript
api.hooks.on(
	"cache-get",
	"before",
	({ path, args }) => {
		const key = `${path}:${JSON.stringify(args)}`;
		const cached = cache.get(key);
		if (cached) return { shortCircuit: true, value: cached };
	},
	{ pattern: "**", priority: 100 }
);

api.hooks.on(
	"cache-set",
	"after",
	({ path, args, result }) => {
		const key = `${path}:${JSON.stringify(args)}`;
		cache.set(key, result);
		return result;
	},
	{ pattern: "**", priority: 0 }
);
```

### Authorization Pattern

```javascript
api.hooks.on(
	"auth-check",
	"before",
	({ path, args }) => {
		if (!context.user.hasPermission(path)) {
			throw new Error(`Unauthorized: ${path}`);
		}
	},
	{ pattern: "admin.*", priority: 1000 }
);
```

### Metrics Tracking

```javascript
const metrics = { calls: 0, errors: 0, durations: [] };

api.hooks.on(
	"metrics-start",
	"before",
	({ path }) => {
		metrics.calls++;
		return { startTime: Date.now() };
	},
	{ pattern: "**" }
);

api.hooks.on(
	"metrics-end",
	"after",
	({ path, result, startTime }) => {
		metrics.durations.push(Date.now() - startTime);
		return result;
	},
	{ pattern: "**" }
);

api.hooks.on(
	"metrics-error",
	"error",
	() => {
		metrics.errors++;
	},
	{ pattern: "**" }
);
```

### Unified Logging

```javascript
api.hooks.on(
	"logger",
	"always",
	({ path, args, result, hasError, errors }) => {
		const timestamp = new Date().toISOString();
		if (hasError) {
			console.error(`[${timestamp}] ${path} FAILED`, {
				args,
				errors: errors.map((e) => e.message)
			});
		} else {
			console.log(`[${timestamp}] ${path} SUCCESS`, {
				args,
				result
			});
		}
	},
	{ pattern: "**" }
);
```

## Breaking Changes

None - the hook system is completely additive with no API modifications.

## Performance Impact

Minimal - hooks disabled by default with fast-path bypass:

```javascript
// When hooks disabled (default):
function call() â†’ Direct execution (no overhead)

// When hooks enabled:
function call() â†’ Hook execution â†’ Function â†’ Hooks
// Optimized for minimal overhead
// Lazy materialization preserved
```

## Migration Guide

### Upgrading from v2.6.x

No code changes required. To use hooks:

```javascript
const api = await slothlet({
	dir: "./api",
	hooks: true // Enable hook system
});

// Register hooks
api.hooks.on("log", "always", ({ path, result, hasError }) => {
	console.log(`${path}:`, hasError ? "ERROR" : result);
});
```

## Related Documentation

- [Hooks Guide](../HOOKS.md) - Complete hook documentation
- [v2.6 Changelog](v2.6.md) - API modernization
- [Performance](../PERFORMANCE.md) - Hook overhead analysis

## Patch Releases

### v2.7.1

- Minor fixes and improvements
- Pre-v2.8.0 stabilization

---

**Full Changelog**: https://github.com/CLDMV/slothlet/compare/v2.6.0...v2.7.0
