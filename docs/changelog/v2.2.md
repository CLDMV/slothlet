# Slothlet v2.2.0 Changelog

**Release Date**: October 16, 2025

## Overview

Version 2.2.0 introduces automatic case preservation options for all-uppercase and all-lowercase identifiers, solving unintended transformations while maintaining complete backward compatibility.

## ðŸ”§ New Features

### Automatic Case Preservation

Two new sanitization options that automatically preserve specific casing patterns:

**`preserveAllUpper`** - Preserve all-uppercase segments:

```javascript
// With preserveAllUpper: true
"COMMON_APPS" â†’ "COMMON_APPS"  // Preserved
"CommonApps"  â†’ "commonApps"   // Still transformed (mixed case)
"HTTP"        â†’ "HTTP"          // Preserved
"Api"         â†’ "api"           // Still transformed (not all-upper)
```

**`preserveAllLower`** - Preserve all-lowercase segments:

```javascript
// With preserveAllLower: true
"common_apps" â†’ "common_apps"  // Preserved
"CommonApps"  â†’ "commonApps"   // Still transformed (mixed case)
"api"         â†’ "api"           // Preserved
"API"         â†’ "api"           // Still transformed (not all-lower)
```

### Smart Case Detection

Intelligent validation ensures only actual letter-based segments are preserved:

```javascript
// Letter validation logic
seg === seg.toUpperCase() &&
seg !== seg.toLowerCase() &&
/[A-Z]/.test(seg)

// Examples:
"123"      â†’ Not preserved (numeric only)
"ABC"      â†’ Preserved (has letters)
"ABC123"   â†’ Preserved (has letters, all upper)
"abc_123"  â†’ Preserved with preserveAllLower (has letters)
```

## ðŸ“Š Usage Example

```javascript
import slothlet from "@cldmv/slothlet";

const api = await slothlet({
	dir: "./api",
	sanitize: {
		lowerFirst: true,
		preserveAllUpper: true, // NEW
		preserveAllLower: true, // NEW
		rules: {
			leave: ["JSON", "API"]
		}
	}
});

// Results:
// COMMON_APPS.mjs â†’ api.COMMON_APPS (preserved - all upper)
// common_utils.mjs â†’ api.common_utils (preserved - all lower)
// ParseJSON.mjs â†’ api.parseJSON (via leave rule, not preserve)
// MixedCase.mjs â†’ api.mixedCase (transformed - not all same case)
```

## ðŸ› ï¸ Technical Details

### Rule Precedence Hierarchy

Enhanced precedence system integrating new preservation options:

```text
1. leave (exact match, case-sensitive)
2. leaveInsensitive (exact match, case-insensitive)
3. preserveAllUpper / preserveAllLower (automatic detection)
4. upper (force uppercase)
5. lower (force lowercase)
```

### Implementation Logic

```javascript
function applyRule(seg, rules) {
	// 1. Exact case-sensitive preservation
	if (rules.leave?.includes(seg)) return seg;

	// 2. Case-insensitive preservation
	if (rules.leaveInsensitive?.some((r) => r.toLowerCase() === seg.toLowerCase())) {
		return seg;
	}

	// 3. Automatic all-upper preservation
	if (options.preserveAllUpper && seg === seg.toUpperCase() && seg !== seg.toLowerCase() && /[A-Z]/.test(seg)) {
		return seg;
	}

	// 4. Automatic all-lower preservation
	if (options.preserveAllLower && seg === seg.toLowerCase() && seg !== seg.toUpperCase() && /[a-z]/.test(seg)) {
		return seg;
	}

	// 5. Force uppercase
	if (rules.upper?.some((p) => matchesPattern(seg, p))) {
		return seg.toUpperCase();
	}

	// 6. Force lowercase
	if (rules.lower?.some((p) => matchesPattern(seg, p))) {
		return seg.toLowerCase();
	}

	// Default transformation
	return seg;
}
```

## ðŸ§ª Testing

Comprehensive test suite with 42 new test cases covering:

- All-uppercase preservation scenarios
- All-lowercase preservation scenarios
- Mixed-case handling (should NOT preserve)
- Numeric-only segments (should NOT preserve)
- Edge cases and boundary conditions
- Rule precedence validation

## Breaking Changes

None - both new options default to `false`, preserving existing behavior.

## Performance Impact

Minimal - preserve checks are lightweight conditional operations that only execute during API initialization.

## Migration Guide

### Upgrading from v2.1.x

No code changes required. To enable case preservation:

```javascript
// Before (v2.1.x behavior maintained)
const api = await slothlet({
	dir: "./api",
	sanitize: { lowerFirst: true }
});

// After (with automatic preservation)
const api = await slothlet({
	dir: "./api",
	sanitize: {
		lowerFirst: true,
		preserveAllUpper: true, // NEW: Keep CONSTANT_NAMES
		preserveAllLower: true // NEW: Keep lowercase_names
	}
});
```

## Use Cases

### Configuration Constants

```javascript
// api/config/DATABASE_URL.mjs
export const DATABASE_URL = "postgres://...";

// With preserveAllUpper: true
api.config.DATABASE_URL; // âœ… Preserved
```

### Snake Case APIs

```javascript
// api/utils/format_date.mjs
export function format_date(date) { ... }

// With preserveAllLower: true
api.utils.format_date()  // âœ… Preserved
```

## Related Documentation

- [API Flattening Rules](../API-FLATTENING.md) - Complete flattening rule reference
- [Module Structure Guide](../MODULE-STRUCTURE.md) - Organization patterns
- [v2.1 Changelog](v2.1.md) - Advanced sanitization control

---

**Full Changelog**: https://github.com/CLDMV/slothlet/compare/v2.1.0...v2.2.0
