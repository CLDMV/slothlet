# Slothlet v2.9.0 Changelog

**Release Date**: December 30, 2025

## Overview

Version 2.9.0 introduces per-request context isolation with `.run()` and `.scope()` methods, plus comprehensive architectural refactoring that consolidates API building logic into focused, maintainable modules. This release enhances developer experience with flexible context merging strategies while improving codebase organization and maintainability.

## ðŸ”„ New Features

### Per-Request Context Isolation

Two new methods for scoped context execution with AsyncLocalStorage-based isolation:

**`api.run()` - Simple Callback API:**

```javascript
const api = await slothlet({ dir: "./api" });

// Execute with merged context
api.run({ requestId: "req-123", user: "alice" }, () => {
	// Context automatically merged for this execution
	api.logger.info("Processing request"); // Has access to requestId and user
	return api.processor.handle();
});

// Pass additional arguments
api.run({ userId: 42 }, api.processor.handle, "data", { options: true });
```

**`api.scope()` - Structured API:**

```javascript
// Structured parameter object
api.scope({
	context: { requestId: "req-456", tenant: "acme" },
	fn: () => {
		return api.database.query();
	}
});

// With arguments
api.scope({
	context: { user: "bob" },
	fn: api.validator.check,
	args: ["input", { strict: true }]
});
```

### Merge Strategies

Choose how request context merges with base context:

**Shallow Merge (Default):**

```javascript
const api = await slothlet({
	dir: "./api",
	context: { app: "myapp", config: { timeout: 5000 } },
	scope: { merge: "shallow" } // Default
});

api.run({ config: { maxRetries: 3 } }, () => {
	// context.config = { maxRetries: 3 }  âœ… Top-level replacement
	// context.app = "myapp"  âœ… Preserved from base
});
```

**Deep Merge:**

```javascript
const api = await slothlet({
	dir: "./api",
	context: { app: "myapp", config: { timeout: 5000, retry: 3 } },
	scope: { merge: "deep" }
});

api.run({ config: { maxRetries: 5 } }, () => {
	// context.config = { timeout: 5000, retry: 3, maxRetries: 5 }  âœ… Merged
	// context.app = "myapp"  âœ… Preserved
});
```

**Disable Scoping:**

```javascript
const api = await slothlet({
	dir: "./api",
	scope: false // Disable per-request context
});

// .run() and .scope() will throw errors
```

### Context Inheritance

Nested `.run()` calls inherit parent request context:

```javascript
const api = await slothlet({
	dir: "./api",
	context: { app: "myapp" },
	scope: { merge: "deep" }
});

api.run({ requestId: "outer" }, () => {
	console.log(context.requestId); // "outer"

	api.run({ userId: 42 }, () => {
		console.log(context.requestId); // "outer" (inherited)
		console.log(context.userId); // 42 (new)
		console.log(context.app); // "myapp" (base)
	});
});
```

### Cross-Mode Support

Works identically across all loading and runtime combinations:

- âœ… Eager + AsyncLocalStorage
- âœ… Eager + Live-bindings
- âœ… Lazy + AsyncLocalStorage
- âœ… Lazy + Live-bindings

## ðŸ—ï¸ Architectural Refactoring

### API Builder Modularization

Split monolithic `api_builder.mjs` (1,731 lines) into focused modules:

**New Structure:**

```plaintext
src/lib/helpers/api_builder/
â”œâ”€â”€ analysis.mjs (581 lines)     - Module analysis and processing
â”œâ”€â”€ decisions.mjs (813 lines)    - Flattening and structure decisions
â”œâ”€â”€ construction.mjs (554 lines) - Final API assembly
â””â”€â”€ add_api.mjs (315 lines)      - Dynamic API extension

api_builder.mjs (48 lines)       - Re-export coordinator
```

**Benefits:**

- **Clear Separation**: Analyze â†’ Decide â†’ Build pipeline
- **Better Maintainability**: Each module under 850 lines
- **Backward Compatible**: All existing imports work unchanged
- **Easier Testing**: Focused unit tests per module
- **Improved Readability**: Related functions grouped logically

### Slothlet Class Consolidation

Reduced main class size through delegation:

**Before:**

- `slothlet.mjs`: 1,696 lines with mixed concerns

**After:**

- `slothlet.mjs`: 1,399 lines (297-line reduction)
- `src/lib/helpers/utilities.mjs`: 205 lines of reusable utilities
- Thin wrapper methods delegate to centralized functions

**Improvements:**

- `_buildCategory` â†’ delegates to `buildCategoryStructure()`
- `_toapiPathKey` â†’ delegates to `toapiPathKey()`
- `_shouldIncludeFile` â†’ delegates to `shouldIncludeFile()`
- `addApiFromFolder` â†’ extracted to dedicated module

### Dead Code Removal

Cleaned up unused experimental code:

- **Removed**: `_buildCategoryEnhanced` (107 lines of unused code)
- **Retained**: `_loadSingleModule` as thin wrapper (mode files depend on it)
- All 27 tests passing after cleanup

### Centralized Utilities

New `utilities.mjs` with general-purpose helpers:

```javascript
// src/lib/helpers/utilities.mjs

/**
 * Safe property definition with non-enumerable default
 */
export function safeDefine(obj, prop, descriptor) { ... }

/**
 * Deep merge objects recursively
 */
export function deepMerge(target, source) { ... }

/**
 * Mutate live binding function with new properties
 */
export function mutateLiveBindingFunction(oldTarget, newTarget) { ... }
```

## ðŸ“š Use Cases

### HTTP Server Per-Request Context

```javascript
// api/server.mjs
import { context } from "@cldmv/slothlet/runtime";
import http from "node:http";

export function createServer(api) {
	return http.createServer((req, res) => {
		// Each request gets isolated context
		api.run(
			{
				requestId: crypto.randomUUID(),
				method: req.method,
				path: req.url,
				startTime: Date.now()
			},
			async () => {
				try {
					const result = await api.handler.process(req);
					api.logger.info(`Request completed`, {
						requestId: context.requestId,
						duration: Date.now() - context.startTime
					});
					res.end(result);
				} catch (error) {
					api.logger.error(`Request failed: ${error.message}`, {
						requestId: context.requestId
					});
					res.statusCode = 500;
					res.end("Internal Server Error");
				}
			}
		);
	});
}
```

### Multi-Tenant Context

```javascript
const api = await slothlet({
	dir: "./api",
	scope: { merge: "deep" }
});

app.use((req, res, next) => {
	// Determine tenant from subdomain
	const tenant = req.hostname.split(".")[0];

	api.scope({
		context: {
			tenant: tenant,
			permissions: getTenantPermissions(tenant),
			config: getTenantConfig(tenant)
		},
		fn: () => next()
	});
});

// All subsequent API calls have tenant-specific context
app.get("/data", (req, res) => {
	// context.tenant automatically set per request
	const data = api.database.query();
	res.json(data);
});
```

### Background Job Context

```javascript
const api = await slothlet({ dir: "./api" });

queue.process(async (job) => {
	return api.run(
		{
			jobId: job.id,
			priority: job.priority,
			attempt: job.attemptsMade
		},
		async () => {
			api.logger.info(`Processing job ${context.jobId}`);

			try {
				const result = await api.processor.execute(job.data);
				api.logger.info(`Job ${context.jobId} completed`);
				return result;
			} catch (error) {
				api.logger.error(`Job ${context.jobId} failed:`, error);
				throw error;
			}
		}
	);
});
```

### Testing Context Isolation

```javascript
import slothlet from "@cldmv/slothlet";

describe("API Tests", () => {
	let api;

	before(async () => {
		api = await slothlet({ dir: "./api" });
	});

	it("should isolate test context", async () => {
		await api.run({ testId: "test-1", user: "alice" }, async () => {
			const result = await api.service.process();
			assert.equal(context.testId, "test-1");
			assert.equal(context.user, "alice");
		});
	});

	it("should have separate context", async () => {
		await api.run({ testId: "test-2", user: "bob" }, async () => {
			const result = await api.service.process();
			assert.equal(context.testId, "test-2");
			assert.equal(context.user, "bob");
		});
	});
});
```

## ðŸ”§ Configuration

### Scope Options

```javascript
const api = await slothlet({
	dir: "./api",

	// Enable with shallow merge (default)
	scope: { merge: "shallow" },

	// Enable with deep merge
	scope: { merge: "deep" },

	// Disable per-request context
	scope: false
});
```

### Default Behavior

When `scope` is not specified:

- Per-request context is **enabled** by default
- Merge strategy defaults to **shallow**

## ðŸ§ª Testing

Comprehensive test coverage added:

**Test File:** `tests/test-per-request-context.mjs` (575 lines)

**Coverage:**

- 17 comprehensive tests
- All 4 mode/runtime combinations (lazy/eager Ã— async/live)
- Shallow vs deep merge strategies
- Context inheritance (nested .run() calls)
- Concurrent request isolation
- Error handling and edge cases

**Test Scenarios:**

```javascript
// Shallow merge validation
api.run({ config: { new: true } }, () => {
	assert.deepEqual(context.config, { new: true });
});

// Deep merge validation
api.run({ config: { new: true } }, () => {
	assert.equal(context.config.timeout, 5000); // Preserved
	assert.equal(context.config.new, true); // Added
});

// Context inheritance
api.run({ outer: 1 }, () => {
	api.run({ inner: 2 }, () => {
		assert.equal(context.outer, 1); // Inherited
		assert.equal(context.inner, 2); // New
	});
});
```

## ðŸ› ï¸ Technical Implementation

### RequestALS Integration

Both runtimes enhanced with request-level AsyncLocalStorage:

**AsyncLocalStorage Runtime:**

```javascript
// src/lib/runtime/runtime-asynclocalstorage.mjs
export const requestALS = new AsyncLocalStorage();

// Runtime proxy checks merge strategy
const mergeStrategy = ctx.config?.scope?.merge || "shallow";
const requestCtx = requestALS.getStore();
const merged = mergeStrategy === "deep" ? deepMerge({}, baseContext, requestCtx) : { ...baseContext, ...requestCtx };
```

**Live-Bindings Runtime:**

```javascript
// src/lib/runtime/runtime-livebindings.mjs
export const requestALS = new AsyncLocalStorage();

// Same merge logic applies
```

### Deep Merge Algorithm

Recursive object merging preserving nested properties:

```javascript
function deepMerge(target, ...sources) {
	for (const source of sources) {
		for (const [key, value] of Object.entries(source)) {
			if (value && typeof value === "object" && !Array.isArray(value)) {
				target[key] = deepMerge(target[key] || {}, value);
			} else {
				target[key] = value;
			}
		}
	}
	return target;
}
```

### Shallow Merge Optimization

Simple object spread for performance:

```javascript
const merged = { ...baseContext, ...requestContext };
```

## ðŸ“Š Code Statistics

### File Changes

```plaintext
37 files changed
+4,579 insertions
-3,211 deletions
Net: +1,368 lines
```

### Key Improvements

- **slothlet.mjs**: 1,696 â†’ 1,399 lines (17.5% reduction)
- **api_builder.mjs**: 1,731 â†’ 48 lines (97.2% reduction, logic moved to submodules)
- **New modules**: 2,205 lines of well-organized API building logic
- **New utilities**: 205 lines of reusable helpers
- **Test coverage**: 575 new test lines for per-request context

## Breaking Changes

None - all changes are backward compatible:

- Per-request context is opt-in via `.run()` and `.scope()` methods
- API builder refactoring maintains all exports
- Existing code continues working without modification

## Performance Impact

### Per-Request Context

- **Shallow merge**: Minimal overhead (~microseconds for object spread)
- **Deep merge**: Slightly higher overhead for recursive merging
- **Disabled (scope: false)**: Zero overhead

### Code Organization

- **Improved maintainability**: Easier to understand and modify
- **Same runtime performance**: No execution overhead from refactoring
- **Better tree-shaking**: More focused modules enable better optimization

## Migration Guide

### Upgrading from v2.8.x

No code changes required. To use per-request context:

```javascript
const api = await slothlet({ dir: "./api" });

// Use .run() for simple cases
api.run({ requestId: "123" }, () => {
	return api.handler.process();
});

// Use .scope() for structured API
api.scope({
	context: { userId: 42 },
	fn: api.processor.execute,
	args: [data]
});
```

### Choosing Merge Strategy

**Use Shallow (default) when:**

- Context objects are flat or simple
- Performance is critical
- Top-level replacement is desired

**Use Deep when:**

- Context has nested configuration
- Need to preserve nested properties
- Merging multiple context layers

## Related Documentation

- [Context Propagation Guide](../CONTEXT-PROPAGATION.md) - Complete context guide
- [API Documentation](../generated/API.md) - Full API reference
- [v2.8 Changelog](v2.8.md) - Dynamic API extension
- [v2.7 Changelog](v2.7.md) - Hook system

## Future Considerations

### v2.9.x Patch Releases

Potential improvements for patch releases:

- Performance optimizations for deep merge
- Additional merge strategies (e.g., custom merge functions)
- Context validation hooks
- Request context debugging utilities

---

**Full Changelog**: https://github.com/CLDMV/slothlet/compare/v2.8.0...v2.9.0
