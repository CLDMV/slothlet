# Slothlet v2.12.0 Changelog

**Release Date**: January 14, 2026

## Overview

Version 2.12.0 introduces production-ready hot reload with reference preservation, fine-grained hook execution control with subsets, comprehensive memory management improvements, and ownership-based rollback system. This release completes the test infrastructure migration to Vitest (100% - 31/31 tests) and includes critical fixes for path resolution in nested helper scenarios and eager mode performance parity with lazy mode.

## ğŸš€ Major Features

### Hot Reload System with Reference Preservation

**Feature**: Complete hot reload implementation enabling dynamic module reloading without breaking consumer references.

**Key Benefits**:
- âœ… **Reference Preservation**: Consumer code doesn't need reassignment after reload
- âœ… **Auto-Cleanup**: Prevents orphan functions when reloading modules
- âœ… **Bidirectional Tracking**: Module ownership system tracks all API paths per module
- âœ… **Cache Isolation**: New instanceId on each reload prevents stale module caches

**Basic Usage**:

```javascript
const api = await slothlet({ 
  dir: "./api", 
  hotReload: true  // Enable hot reload
});

// ... modify source files ...

await api.reload();  // Re-initialize with updated modules
// api reference still valid - no reassignment needed! âœ…
```

**Advanced: Module Ownership with Auto-Cleanup**:

```javascript
const api = await slothlet({ 
  dir: "./api", 
  hotReload: true  // Enables module ownership tracking
});

// Load plugin v1 with module ownership
await api.addApi("plugins", "./plugins/v1", { 
  moduleId: "my-plugin" 
});
// Creates: api.plugins.featureA, api.plugins.featureB

// Later: Same module reloads with v2 (auto-cleanup applies)
await api.addApi("plugins", "./plugins/v2", { 
  moduleId: "my-plugin"  // Same moduleId triggers auto-cleanup
});
// âœ… Rule 13: Old "my-plugin" paths automatically removed BEFORE loading v2
// âœ… New v2 functions replace them cleanly
// âœ… No orphan functions from v1 left behind
// Result: Only v2 functions (featureC, featureD) exist at api.plugins.*

// Note: Auto-cleanup only applies to same-module reloads (same moduleId).
// Cross-module overwrites still require allowApiOverwrite: true for Rule 12.
```

**Manual Removal**:

```javascript
// Remove by path
await api.removeApi("plugins.featureA");

// Remove all paths for a module
await api.removeApi({ moduleId: "my-plugin" });
```

**Technical Details**:
- In-place mutation preserves existing references (`boundApi`)
- Lazy mode proxies preserved via recursive mutation
- All 7 management methods copied correctly (previously only 3)
- Execution order: Path resolution â†’ Rule 12 check â†’ Auto-cleanup â†’ Load new modules

**Related Files**:
- `src/slothlet.mjs` - Core reload logic
- `src/lib/helpers/api_builder/add_api.mjs` - Reference preservation
- `src/lib/helpers/api_builder/remove_api.mjs` - Removal and cleanup

---

### Ownership-Based Rollback System

**Feature**: Complete rollback chain tracking enables restoring previous module implementations when removing modules.

**Key Benefits**:
- âœ… **Full Rollback Chain**: Tracks core â†’ v1 â†’ v2 ownership history
- âœ… **Automatic Restoration**: Removing v2 automatically restores v1 implementation
- âœ… **Core Function Tracking**: Initial slothlet functions tracked as "core" for complete rollback
- âœ… **Safe Removal**: Removing all modules restores original slothlet functionality

**Basic Usage**:

```javascript
const api = await slothlet({ 
  dir: "./api", 
  hotReload: true  // Enables ownership tracking
});

// Initial state: api.myFunc exists from core load (tracked as "core")

// Load plugin v1
await api.addApi("plugins", "./plugins/v1", {}, { 
  moduleId: "plugin-v1" 
});
// api.myFunc now owned by: ["core", "plugin-v1"]

// Load plugin v2 (overwrites v1's function)
await api.addApi("plugins", "./plugins/v2", {}, { 
  moduleId: "plugin-v2",
  forceOverwrite: true 
});
// api.myFunc now owned by: ["core", "plugin-v1", "plugin-v2"]

// Remove v2 â†’ Automatically rolls back to v1 implementation
await api.removeApi({ moduleId: "plugin-v2" });
// api.myFunc restored to plugin-v1's implementation
// Ownership: ["core", "plugin-v1"]

// Remove v1 â†’ Automatically rolls back to core implementation
await api.removeApi({ moduleId: "plugin-v1" });
// api.myFunc restored to original slothlet core implementation
// Ownership: ["core"]
```

**Technical Details**:
- **Array-Based Ownership**: Changed from Set to Array to preserve rollback order
- **Current Owner Tracking**: `_getCurrentOwner(apiPath)` returns last owner in chain
- **Core Registration**: `_registerInitialCoreOwnership()` tracks initial functions with "core" moduleId
- **Rollback Detection**: When removing current owner, finds previous owner and re-executes their `addApi`
- **Special Core Handling**: Restores core functions by reloading from `instance.config.dir`
- **Circular Reference Protection**: Visited WeakSet prevents infinite recursion in proxy traversal

**Test Coverage**: 24 tests across 8 matrix configurations verifying:
- Full rollback chain: core â†’ v1 â†’ v2 â†’ v1 â†’ core
- Ownership accumulation tracking
- Function implementation restoration
- Shared ownership when merging properties

**Related Files**:
- `src/slothlet.mjs` - Ownership tracking system
- `src/lib/helpers/api_builder/remove_api.mjs` - Rollback logic
- `tests/vitests/suites/ownership/ownership-replacement.test.vitest.mjs` - Comprehensive tests

---

### Hook Subset System (before/primary/after)

**Feature**: Fine-grained control over hook execution order within each hook type using three execution phases.

**Execution Order**: Within each hook type â†’ subset (before/primary/after) â†’ priority (highest first) â†’ registration order

**Basic Usage**:

```javascript
const api = await slothlet({ dir: "./api" });

// Setup phase - runs before main logic
api.hooks.before("myFunc", { 
  subset: "before", 
  priority: 100 
}, (ctx) => {
  ctx.startTime = Date.now();
  console.log("Setup: Preparing execution");
});

// Main logic - default 'primary' subset
api.hooks.before("myFunc", (ctx) => {
  console.log("Primary: Core business logic");
  ctx.result = processData(ctx.args);
});

// Cleanup phase - runs after main logic
api.hooks.before("myFunc", { 
  subset: "after" 
}, (ctx) => {
  const duration = Date.now() - ctx.startTime;
  console.log(`Cleanup: Took ${duration}ms`);
});
```

**Advanced: Performance Monitoring**:

```javascript
// Setup: Start timer
api.hooks.before("api.*", { subset: "before" }, (ctx) => {
  ctx.perfStart = performance.now();
});

// Cleanup: Record metrics
api.hooks.after("api.*", { subset: "after" }, (ctx) => {
  const duration = performance.now() - ctx.perfStart;
  metrics.record(ctx.fnPath, duration);
});
```

**Transaction Management**:

```javascript
// Begin transaction before main logic
api.hooks.before("database.*", { subset: "before" }, async (ctx) => {
  ctx.transaction = await db.beginTransaction();
});

// Commit after main logic completes
api.hooks.after("database.*", { subset: "after" }, async (ctx) => {
  if (!ctx.error) {
    await ctx.transaction.commit();
  } else {
    await ctx.transaction.rollback();
  }
});
```

**Subset Properties**:
- **before**: Setup, initialization, pre-processing
- **primary**: Main business logic (default when subset not specified)
- **after**: Cleanup, finalization, post-processing
- **Backward Compatible**: Existing hooks without subset automatically use 'primary'
- **Applies to All Hook Types**: before, after, always, error

**Technical Details**:
- Modified `HookManager._getMatchingHooks()` sorting logic
- Comprehensive validation with clear error messages
- Fixed hooks API wrapper signature to match `HookManager.on()` (3 params)

**Test Coverage**: 184 tests across 8 matrix configurations

**Related Documentation**: [docs/HOOKS.md](../HOOKS.md)

---

### Memory Management: AsyncLocalStorage Cleanup

**Feature**: Proper ALS cleanup prevents memory leaks in long-running applications.

**Problem Solved**: ALS instances were persisting after shutdown/reload, causing:
- Memory leaks in long-running servers
- Stale context stores bleeding across instances
- Accumulated runtime state over multiple reloads

**Solution**:

```javascript
// Cleanup automatically called in shutdown()
await api.shutdown();
// âœ… ALS instances disabled and removed from registry
// âœ… boundapi.__ctx property deleted
// âœ… All runtime state cleaned up

// Cleanup automatically called in reload()
await api.reload();
// âœ… Old ALS cleaned up before creating new one
// âœ… Prevents memory leaks on repeated reloads
// âœ… Safe for production hot reload scenarios
```

**Idempotent Cleanup**:

```javascript
// Multiple calls are safe
await api.shutdown();
await api.shutdown();  // âœ… No error, silently succeeds
await api.reload();    // âœ… Works even after shutdown
```

**Additional Fixes**:
- **Map/Set Proxy Handling**: Fixed iteration, accessors, and membership tests
- **Runtime State Cleanup**: Exported `cleanup()` from runtime-asynclocalstorage
- **Delete ctx Before Reassign**: Prevents reference leaks during shutdown

**Test Coverage**: 48 tests covering:
- Shutdown cleanup verification
- ALS disable confirmation
- Sequential isolation across instances
- Idempotent shutdown behavior
- Reload after shutdown
- Multiple reload memory leak prevention

**Related Files**:
- `src/lib/runtime/runtime-asynclocalstorage.mjs`
- `src/lib/runtime/runtime-livebindings.mjs`
- `src/slothlet.mjs`

---

## ğŸ› Bug Fixes

### Critical: Path Resolution for Nested Helpers

**Issue**: When `addApi()` was called from a helper function, path resolver incorrectly used slothlet's internal runtime files as the base instead of user code files.

**Problem Scenario**:

```javascript
// File: tests/nested/helper-executor.mjs
export function executeAddApi(api, path) {
  // This helper wraps addApi call
  await api.addApi("test", path);
}

// User code calls helper
import { executeAddApi } from "./nested/helper-executor.mjs";
await executeAddApi(api, "../../api_tests/api_test_mixed");

// âŒ Bug: Path resolved from src/lib/runtime/runtime-asynclocalstorage.mjs
// âŒ Result: 'src/api_tests/api_test_mixed' (wrong location)
```

**Root Cause**:
- `isSlothletInternalFile()` used `path.sep` (backslash on Windows) for detection
- V8 stack traces always use forward slashes
- Path separator mismatch caused slothlet internal files to not be skipped
- Fallback used first frame (runtime internal) instead of user code frame

**Solution**:

```javascript
// Establish package boundary
const SLOTHLET_ROOT = path.resolve(THIS_DIR, "..", "..", "..");

// Proper detection with path normalization
function isSlothletInternalFile(fileName) {
  const normalized = fileName.replace(/\\/g, "/");
  
  // Check if within slothlet package
  if (!normalized.startsWith(SLOTHLET_ROOT.replace(/\\/g, "/"))) {
    return false;
  }
  
  // Only skip files in src/lib/ or dist/lib/
  const relative = path.relative(SLOTHLET_ROOT, fileName);
  const relNorm = relative.replace(/\\/g, "/");
  return relNorm.startsWith("src/lib/") || relNorm.startsWith("dist/lib/");
}
```

**Benefits**:
- âœ… Correctly identifies user code vs slothlet internals
- âœ… Cross-platform compatible (Windows/Linux/macOS)
- âœ… Package-scoped detection prevents false positives
- âœ… Removed fragile `includes()` pattern

**Impact**: All 16 failing `addapi-path-resolution` tests now pass

**Related File**: `src/lib/helpers/resolve-from-caller.mjs`

---

### Performance: Eager Mode Function Call Parity

**Issue**: Eager mode had 6-8x performance penalty on function calls compared to lazy mode after materialization.

**Root Cause**: Eager mode was missing `__slothletPath` assignment, causing wrapper's get trap to call `Object.defineProperty` on every function access.

**Solution**: Added `eager_assignSlothletPaths()` to recursively assign `__slothletPath` to all functions in the API tree after initial load.

**Performance Results**:

| Mode | Before | After | Improvement |
|------|--------|-------|-------------|
| **Lazy** | 1.16Î¼s | 1.14Î¼s | 2% faster |
| **Eager** | 1.31Î¼s | 1.23Î¼s | **6% faster** |
| **Difference** | 12% | 8% | **33% reduction** |

Post-materialization function calls now essentially identical between modes (8% difference is within measurement noise).

**Technical Details**:
- Recursive path assignment to all functions in API tree
- Called after `mutateLiveBindingFunction()` in slothlet core
- Ensures eager and lazy modes have identical post-load behavior

**Related Files**:
- `src/lib/modes/slothlet_eager.mjs` - Path assignment logic
- `src/slothlet.mjs` - Integration

---

### Fixed: ESLint Compliance for Catch Variables

**Issue**: 5 ESLint violations in hook-subsets test for unused catch variables.

**Problem**:

```javascript
// âŒ ESLint error: 'error' is defined but never used
try {
  await api.someFunc();
} catch (error) {
  // Error intentionally unused in these tests
}
```

**Solution**:

```javascript
// âœ… Matches caughtErrorsIgnorePattern: "^(_|___.*)$"
try {
  await api.someFunc();
} catch (_) {
  // Underscore explicitly signals unused variable
}
```

**Related File**: `tests/vitests/suites/hooks/hook-subsets.test.vitest.mjs`

---

## ğŸ§ª Test Infrastructure Modernization

### 100% Vitest Migration Complete

**Achievement**: All 31 migratable tests successfully converted to Vitest matrix testing.

**Migration Status**:
- âœ… **31/31 tests migrated** (100% completion)
- âœ… **2 tests intentionally skipped** (CJS-only, entry-points - documented rationale)
- âœ… **38 obsolete files removed** (11,656 lines of legacy test code)
- âœ… **4,194 total tests** passing across all matrix configurations

**Test Organization**:

```text
tests/vitests/suites/
â”œâ”€â”€ addapi/               # AddApi functionality (3 test files)
â”œâ”€â”€ api/                  # API structure tests (9 test files, eager/lazy split)
â”œâ”€â”€ context/              # Context isolation & ALS (5 test files)
â”œâ”€â”€ diagnostics/          # Mixed diagnostic scenarios
â”œâ”€â”€ hooks/                # Hook system (12 test files, comprehensive coverage)
â”œâ”€â”€ hot-reload/           # Hot reload functionality (4 test files)
â”œâ”€â”€ isolation/            # Multi-instance & TV config (2 test files)
â”œâ”€â”€ listeners/            # Event listener cleanup (2 test files)
â”œâ”€â”€ metadata/             # Metadata API tests
â”œâ”€â”€ ownership/            # Module ownership & removal
â”œâ”€â”€ proxies/              # Proxy baseline tests
â”œâ”€â”€ reference/            # Reference readonly properties
â”œâ”€â”€ rules/                # API rules (Rule 12, etc.)
â”œâ”€â”€ sanitization/         # Filename sanitization
â””â”€â”€ smart-flattening/     # Smart flattening cases (4 test files)
```

---

### New Comprehensive Test Runner

**Feature**: Complete rewrite of Vitest test runner with professional CI/CD features.

**Capabilities**:
- âœ… **True Concurrent Worker Pool**: `Promise.race()` for optimal parallelism
- âœ… **ANSI-Preserving Error Display**: Full Vitest formatting maintained
- âœ… **Skip Test Parsing**: Reports skipped tests with reasons
- âœ… **Start Time Display**: HH:MM:SS format for execution tracking
- âœ… **Dual Duration Tracking**: Wall-clock vs sum of test times
- âœ… **Memory Reporting**: Script heap + RSS for resource monitoring
- âœ… **Proper Exit Codes**: 0 for success, 1 for failures (CI/CD ready)

**Usage**:

```bash
# Run all tests with comprehensive runner
npm run test:unit

# Alternative alias
npm run vitest:all

# Run single file with native Vitest
npm run vitest:single path/to/test.vitest.mjs
```

**Output Example**:

```bash
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                VITEST TEST RUNNER - STARTED                  â•‘
â•‘  Start Time: 14:25:30                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[1/56] âœ… PASS (2.3s) - api/eager/api-eager-basic.test.vitest.mjs
[2/56] âœ… PASS (1.8s) - api/lazy/api-lazy-basic.test.vitest.mjs
...
[56/56] âœ… PASS (3.2s) - smart-flattening/edge-cases.test.vitest.mjs

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ALL TESTS COMPLETE                        â•‘
â•‘  Total: 4,194 passed, 0 failed                               â•‘
â•‘  Wall Clock: 171.2s | Test Time: 156.8s                      â•‘
â•‘  Memory: 45.2MB heap, 178.4MB RSS                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Related Files**:
- `tests/vitests/run-all-vitest.mjs` - New comprehensive runner (519 lines)
- Previous `tools/run-vitest-per-file.mjs` - Removed (obsolete)

---

### Hooks Test Suite Improvements

**Comprehensive Hook Coverage**:

Reorganized massive `hooks-comprehensive` test into focused files:

| File | Tests | Focus Area |
|------|-------|------------|
| `hooks-after-chaining.test.vitest.mjs` | 115 | After hook chaining scenarios |
| `hooks-before-chaining.test.vitest.mjs` | 139 | Before hook chaining scenarios |
| `hooks-mixed-scenarios.test.vitest.mjs` | 224 | Complex multi-hook interactions |
| `hooks-short-circuit.test.vitest.mjs` | 164 | Short-circuit behavior |
| `hook-subsets.test.vitest.mjs` | 184 | **New: Subset system testing** |

**Benefits**:
- Reduced memory usage per test file
- Easier to identify failing scenarios
- Better test organization and maintainability
- Comprehensive coverage of all hook patterns

---

### API Test Reorganization

**Eager/Lazy Mode Split**:

```text
api/
â”œâ”€â”€ eager/
â”‚   â”œâ”€â”€ api-eager-basic.test.vitest.mjs      # Core eager mode
â”‚   â”œâ”€â”€ api-eager-hooks.test.vitest.mjs      # Eager + hooks integration
â”‚   â”œâ”€â”€ api-eager-hot.test.vitest.mjs        # Eager + hot reload
â”‚   â””â”€â”€ api-eager-live.test.vitest.mjs       # Eager + live bindings
â””â”€â”€ lazy/
    â”œâ”€â”€ api-lazy-basic.test.vitest.mjs       # Core lazy mode
    â”œâ”€â”€ api-lazy-hooks.test.vitest.mjs       # Lazy + hooks integration
    â”œâ”€â”€ api-lazy-hot.test.vitest.mjs         # Lazy + hot reload
    â””â”€â”€ api-lazy-live.test.vitest.mjs        # Lazy + live bindings
```

**Benefits**:
- Clear separation of mode-specific behavior
- Easy to identify mode-specific issues
- Comprehensive integration testing
- All combinations covered in matrix

---

## ğŸ“š Documentation Updates

### Comprehensive AGENT-USAGE.md Expansion

**Added Missing Feature Documentation**:

#### Per-Request Context (v2.9)
- `api.run()` single-call context patterns
- `api.scope()` multi-call context patterns
- Merge strategy examples (shallow/deep)

#### EventEmitter Context Propagation
- Automatic context flow through registered emitters
- Integration patterns with third-party libraries

#### Metadata System (v2.10)
- Function tagging patterns
- Runtime introspection with `metadataAPI`
- Authorization check patterns

#### Hot Reload System (v2.12)
- Reference preservation benefits
- Module ownership with auto-cleanup
- Dynamic plugin loading patterns

**Reorganization**:
- Sections now in chronological version order
- Updated all non-README.md links to GitHub repo URLs
- Expanded AI Agent Checklist with new feature considerations

**Related File**: `AGENT-USAGE.md` (+222 lines)

---

### Enhanced HOOKS.md Documentation

**Added Subset System Documentation**:
- Three execution phases explained with diagrams
- Use cases with comprehensive code examples
- Interaction with priority system clarified
- Migration guide for existing hooks

**Related File**: `docs/HOOKS.md` (+210 lines total)

---

### TEST-MIGRATION-TRACKER.md Updates

**Status Update**:
- Marked 31/31 migratable tests as finalized (100% complete)
- Documented 2 intentionally skipped tests with technical rationale
- Removed non-existent test from pending list
- Added comprehensive migration notes

**Related File**: `tests/TEST-MIGRATION-TRACKER.md`

---

### Performance Documentation

**Added Investigation Scripts**:
- `tests/performance/inspect-functions.mjs` - Compare function implementations
- `tests/performance/test-function-identity.mjs` - Test object identity across modes
- `tests/performance/test-jit-optimization.mjs` - Investigate V8 JIT optimization
- `tests/performance/test-math-structure.mjs` - Compare API structures
- `tests/performance/test-proxy-overhead.mjs` - Measure proxy overhead

**Enhanced Benchmark**:
- `tests/performance/performance-benchmark-aggregated.mjs` - Expanded analysis

**Related File**: `docs/PERFORMANCE.md`

---

### README.md Updates

**Changes**:
- Updated feature list to reflect hot reload system
- Fixed documentation links to use proper GitHub URLs
- Updated What's New section for v2.12

**Related File**: `README.md`

---

## ğŸ”§ Configuration Changes

### NPM Scripts Update

**Added**:
- `vitest:all` - Alias for running all Vitest tests
- `vitest:single` - Run individual files with native Vitest

**Updated**:
- `test:unit` - Now uses comprehensive runner (`tests/vitests/run-all-vitest.mjs`)

**Removed**:
- `vitest:per-file` - Replaced by comprehensive runner
- `vitest:full` - Replaced by vitest:all
- `test:vitest` - Redundant

---

### Vitest Configuration

**Updates**:
- `.configs/vitest.config.mjs` - Enhanced to support new test structure
- Full 20-configuration matrix testing (5 mode/runtime combinations Ã— 4 hook configs)

---

## âš ï¸ Breaking Changes

### Rule 13: Auto-Cleanup with Module Ownership

**When**: `hotReload: true` + `moduleId` provided to `addApi()` + **same moduleId being reloaded**

**Behavior**: When reloading a module with the **same moduleId**, all previous API paths owned by that module are **automatically removed** before loading new ones. This is a same-module update, not cross-module overwrite.

**Key Points**:
- âœ… Auto-cleanup applies to **same-module reloads** (same `moduleId`)
- âœ… Happens **before** module loading (Rule 13 executes before Rule 12 checks)
- âŒ Cross-module overwrites still require `allowApiOverwrite: true` (Rule 12)
- âŒ Skipped when `mutateExisting: true` (preserves references during reload)

**Before**:

```javascript
// First load
await api.addApi("plugins", "./plugins/v1", { moduleId: "my-plugin" });
// api.plugins.featureA, api.plugins.featureB

// Second load (old behavior)
await api.addApi("plugins", "./plugins/v2", { moduleId: "my-plugin" });
// âŒ api.plugins.featureA still exists (orphan from v1)
// âœ… api.plugins.featureC added from v2
// Result: Mix of old and new functions
```

**After**:

```javascript
// First load
await api.addApi("plugins", "./plugins/v1", { moduleId: "my-plugin" });
// api.plugins.featureA, api.plugins.featureB

// Second load (new behavior)
await api.addApi("plugins", "./plugins/v2", { moduleId: "my-plugin" });
// âœ… api.plugins.featureA automatically removed
// âœ… api.plugins.featureB automatically removed
// âœ… api.plugins.featureC added from v2
// Result: Clean v2 functions only
```

**Migration**:

If you were manually calling `removeApi()` before reloading:

```javascript
// Old pattern (no longer needed)
await api.removeApi({ moduleId: "my-plugin" });
await api.addApi("plugins", "./plugins/v2", { moduleId: "my-plugin" });

// New pattern (auto-cleanup)
await api.addApi("plugins", "./plugins/v2", { moduleId: "my-plugin" });
// Cleanup happens automatically
```

**Execution Order**:
1. Path resolution (synchronous)
2. Rule 12: Cross-module ownership check
3. **Rule 13: Auto-cleanup** (removes module's existing paths)
4. Load new modules

---

## ğŸ“Š Statistics

### Code Changes Summary

| Category | Additions | Deletions | Net Change |
|----------|-----------|-----------|------------|
| **Source Code** | ~1,200 | ~400 | +800 |
| **Tests** | ~3,500 | ~11,700 | **-8,200** |
| **Documentation** | ~900 | ~500 | +400 |
| **TypeScript Defs** | ~8,500 | ~3,500 | +5,000 |
| **Total** | ~14,100 | ~16,100 | **-2,000** |

### Test Coverage Evolution

| Metric | v2.11 | v2.12 | Change |
|--------|-------|-------|--------|
| **Total Tests** | 4,178 | 4,194 | +16 |
| **Vitest Migration** | 28/31 (90%) | 31/31 (100%) | **+3 (100%)** |
| **Hook Tests** | ~200 | ~384 | +184 |
| **ALS Cleanup Tests** | 0 | 48 | +48 |
| **Hot Reload Tests** | 144 | 144 | 0 |

### Performance Improvements

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| **Eager vs Lazy Gap** | 12% | 8% | **33% reduction** |
| **Eager Absolute** | 1.31Î¼s | 1.23Î¼s | **6% faster** |
| **Lazy Absolute** | 1.16Î¼s | 1.14Î¼s | 2% faster |

---

## ğŸ¯ Migration Guide

### Upgrading from v2.11 to v2.12

**1. Enable Hot Reload (Optional)**:

```javascript
// Before
const api = await slothlet({ dir: "./api" });

// After (if you want hot reload)
const api = await slothlet({ 
  dir: "./api", 
  hotReload: true  // Opt-in feature
});
```

**2. Update Module Ownership Pattern (If Using)**:

```javascript
// Old: enableModuleOwnership (deprecated but still works)
const api = await slothlet({ 
  dir: "./api", 
  enableModuleOwnership: true 
});

// New: hotReload (preferred)
const api = await slothlet({ 
  dir: "./api", 
  hotReload: true 
});
```

**3. Remove Manual Cleanup (If Auto-Cleanup Desired)**:

```javascript
// Before: Manual cleanup before reload
await api.removeApi({ moduleId: "plugin" });
await api.addApi("plugins", "./new", { moduleId: "plugin" });

// After: Auto-cleanup (if hotReload: true)
await api.addApi("plugins", "./new", { moduleId: "plugin" });
```

**4. Adopt Hook Subsets (Optional)**:

```javascript
// Before: Only priority for ordering
api.hooks.before("func", { priority: 100 }, setupHook);
api.hooks.before("func", { priority: 50 }, mainHook);
api.hooks.before("func", { priority: 10 }, cleanupHook);

// After: Use subsets for clearer intent
api.hooks.before("func", { subset: "before" }, setupHook);
api.hooks.before("func", { subset: "primary" }, mainHook);
api.hooks.before("func", { subset: "after" }, cleanupHook);
```

**5. No Code Changes Required For**:
- Path resolution fix (automatic)
- Eager mode performance (automatic)
- ALS cleanup (automatic)
- Test infrastructure (internal)

---

## ğŸ”® Future Roadmap Implications

### Hot Reload Foundation Enables

- **File Watcher Integration**: Auto-reload on source file changes
- **IDE Plugin Support**: Live code sync with running applications
- **Development Environments**: Hot module replacement patterns
- **Dynamic Plugin Systems**: Runtime plugin loading/unloading

### Hook Subset Patterns Enable

- **Standardized Setup/Teardown**: Consistent hook patterns across projects
- **Performance Monitoring**: Built-in instrumentation hooks
- **Transaction Management**: Database transaction lifecycle hooks
- **Debugging/Tracing**: Structured debugging hook integration

### Memory Management Enables

- **Long-Running Servers**: Production-ready memory safety
- **Plugin Systems**: Safe dynamic loading/unloading
- **High-Concurrency Environments**: Isolated request handling
- **Microservice Architectures**: Clean instance lifecycle management

### Test Infrastructure Enables

- **Easy Test Addition**: Standardized Vitest matrix setup
- **CI/CD Optimization**: Parallel execution with comprehensive reporting
- **Better Coverage Tracking**: Memory-efficient large test suites
- **Comprehensive Validation**: Matrix testing across all configurations

---

## ğŸ“ Technical Highlights

### Architectural Improvements

1. **Reference Preservation**
   - In-place mutation instead of reassignment
   - Lazy mode proxy preservation via recursive mutation
   - Consumer code doesn't track references after reload

2. **Hook Subset Sorting**
   - Three-phase execution (before/primary/after)
   - Maintains backward compatibility with automatic 'primary'
   - Integrates seamlessly with existing priority system

3. **ALS Cleanup Strategy**
   - Explicit cleanup in both `shutdown()` and `reload()`
   - Prevents leaks in long-running processes
   - Idempotent cleanup allows safe multiple calls

4. **Path Resolution Robustness**
   - Package-boundary based detection
   - Proper path normalization for cross-platform
   - Eliminated fragile `includes()` patterns

5. **Test Infrastructure Modernization**
   - Complete Vitest matrix migration (100%)
   - Concurrent worker pool for CI/CD
   - Comprehensive error reporting with ANSI preservation

---

## ğŸ“ Related Documentation

- **Hot Reload**: Code examples in this changelog
- **Hook Subsets**: [docs/HOOKS.md](../HOOKS.md)
- **Memory Management**: [src/lib/runtime/runtime-asynclocalstorage.mjs](../../src/lib/runtime/runtime-asynclocalstorage.mjs)
- **Test Infrastructure**: [tests/TEST-MIGRATION-TRACKER.md](../../tests/TEST-MIGRATION-TRACKER.md)
- **AI Agent Guide**: [AGENT-USAGE.md](../../AGENT-USAGE.md)

---

## ğŸ™ Acknowledgments

This release represents significant effort across multiple architectural improvements, with particular focus on production readiness for hot reload scenarios and comprehensive test infrastructure modernization. Special thanks to all contributors and users who provided feedback during the development cycle.

---

**Full Commit Range**: `8ecbc32b` through `1a27bfc3` (20 commits)  
**Development Period**: January 5-14, 2026  
**Total Files Changed**: ~150+  
**Lines Changed**: +14,100 / -16,100 (net: -2,000)
