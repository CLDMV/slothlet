# Slothlet v2.6.0 Changelog

**Release Date**: November 10, 2025

## Overview

Version 2.6.0 delivers API modernization with cleaner option semantics, fixes critical lazy loading bugs for deep nested paths, and consolidates documentation. This release establishes semantic separation between loading strategy and execution environment while maintaining 100% backward compatibility.

## ðŸš€ New Features

### API Modernization - Mode and Engine Options

Introduces semantic clarity with new configuration options:

**Modern Syntax:**

```javascript
const api = await slothlet({
	dir: "./api",
	mode: "lazy", // Loading strategy: "lazy" | "eager"
	engine: "singleton" // Execution environment
});
```

**Legacy Syntax (Still Supported):**

```javascript
const api = await slothlet({
	dir: "./api",
	lazy: true, // Still works
	mode: "singleton" // Now called "engine"
});
```

**Benefits:**

- **Semantic Clarity**: `mode` clearly indicates loading strategy
- **Separation of Concerns**: Loading vs execution are distinct concepts
- **100% Backward Compatible**: All existing code works unchanged
- **Intelligent Precedence**: New options take priority when both provided

**Option Resolution:**

```javascript
// Loading mode
loadingMode = options.mode === "lazy" || options.mode === "eager" ? options.mode : options.lazy ? "lazy" : "eager";

// Execution environment
executionEngine = options.engine || options.mode || "singleton";
```

## ðŸ”§ Critical Bug Fixes

### Deep Nested Path Materialization

Fixed lazy loading failure for paths with 4+ levels of nesting:

**The Problem:**

```javascript
// Deep nested paths failed in lazy mode
api.singletest.helper.utilities.format();
// TypeError: ... is not a function
```

**Root Cause:**

- `lazy_deepPropertyAccessor` proxy missing `get` handler
- Materialization chain broke for deep object traversal
- Duplicate `inFlight` check caused race conditions

**The Solution:**

```javascript
// Added recursive get handler
const lazy_deepPropertyAccessor = new Proxy(target, {
	get(target, prop) {
		// Recursive property access for unlimited nesting
		if (typeof target[prop] === "object") {
			return new Proxy(target[prop], lazy_deepPropertyAccessor);
		}
		return target[prop];
	},
	apply(target, thisArg, args) {
		// Materialize and execute
		return runWithCtx(ctx, target, thisArg, args);
	}
});
```

**Now Works:**

```javascript
// All nesting levels work identically in lazy mode
api.level1.level2.level3.level4(); // âœ… Works!
api.singletest.helper.utilities.format(); // âœ… Fixed!
```

### Enhanced Instance Manager

Improved runtime system with split AsyncLocalStorage/live-bindings implementations:

**New Files:**

- `src/lib/runtime/runtime-asynclocalstorage.mjs` - AsyncLocalStorage implementation
- `src/lib/runtime/runtime-livebindings.mjs` - Live bindings implementation
- `src/lib/helpers/instance-manager.mjs` - Shared instance detection

**Benefits:**

- Clear separation of runtime concerns
- Easier maintenance and debugging
- Better code organization
- Consistent behavior across runtimes

## ðŸ“‹ Documentation Consolidation

### Reduced Redundancy

Consolidated from 4 redundant files to 2 authoritative sources:

**Kept:**

- `API-RULES.md` - 20 comprehensive transformation rules
- `API-RULES-CONDITIONS.md` - 26 technical conditions

**Removed (Outdated):**

- `VERIFIED-API-RULES.md` - Redundant verification
- `CONDITIONS-RULES-ANALYSIS.md` - Working document
- `MERGE.md` - Temporary analysis
- `TODO-optimize.md` â†’ Renamed to `OPTIMIZATION-OPPORTUNITIES.md`

**Impact:**

- Eliminates maintenance overhead
- Single source of truth for rules
- Clearer documentation structure
- Updated cross-references in README and CONTRIBUTING

### Enhanced Test Modules

New comprehensive test files demonstrating patterns:

```plaintext
api_tests/api_test/
â”œâ”€â”€ singletest/helper.mjs       - Deep nesting test
â”œâ”€â”€ task/parse-json.mjs         - JSON preservation
â”œâ”€â”€ util/get-http-status.mjs    - HTTP preservation
â”œâ”€â”€ util/xml-parser.mjs         - XML preservation
â””â”€â”€ mixed/mixed.mjs             - Mixed export patterns
```

## ðŸ› ï¸ Technical Improvements

### Function Name Preservation

Enhanced logic respecting programming conventions:

```javascript
// Preserves technical terms in final API paths
auto-ip.mjs â†’ api.autoIP       // IP preserved
parse-json.mjs â†’ api.parseJSON // JSON preserved
get-http-status.mjs â†’ api.getHTTPStatus  // HTTP preserved
xml-parser.mjs â†’ api.XMLParser // XML preserved
```

**Implementation:**

```javascript
const preservedTerms = ["IP", "JSON", "HTTP", "XML", "API", "URL"];
function smartCasePreservation(name) {
	return name.replace(/\b(IP|JSON|HTTP|XML|API|URL)\b/g, (match) => match);
}
```

### Lazy Loading Enhancements

Comprehensive proxy system improvements:

1. **Recursive Get Handler**: Unlimited nesting depth support
2. **Removed Duplicate Checks**: Eliminated `inFlight` race conditions
3. **Enhanced Materialization**: Proper copy-left behavior
4. **Debug Support**: Better error messages and stack traces

## ðŸ§ª Testing Infrastructure

### Enhanced Debug Script

`tests/debug-slothlet.mjs` improvements:

- Tests all API paths automatically (98+ paths)
- Deep nested path validation
- Eager vs lazy comparison
- Detailed materialization verification
- Comprehensive output analysis

### Validation Coverage

**Rules Tested:**

- Rule 8 Pattern B (Mixed Export Flattening)
- Rule 8 Pattern C (Non-matching Object Export)
- Rule 9 (Function Name Preference with multiple cases)
- Deep nested path handling (4+ levels)

## Breaking Changes

None - all changes maintain full backward compatibility.

## Performance Impact

Neutral - lazy loading improvements maintain performance characteristics while fixing deep nesting edge cases.

## Migration Guide

### Upgrading from v2.5.x

**Option 1: Keep existing code (recommended)**

```javascript
// Existing code continues working
const api = await slothlet({
	dir: "./api",
	lazy: true
});
```

**Option 2: Adopt modern syntax**

```javascript
// New semantic clarity
const api = await slothlet({
	dir: "./api",
	mode: "lazy",
	engine: "singleton"
});
```

### Deep Nested Paths

No code changes needed - deep paths now work automatically:

```javascript
// These just work in v2.6.0+
api.deeply.nested.path.function();
api.level1.level2.level3.level4.level5();
```

## Related Documentation

- [API Rules](../API-RULES.md) - Comprehensive transformation rules
- [API Conditions](../API-RULES-CONDITIONS.md) - Technical implementation
- [Module Structure](../MODULE-STRUCTURE.md) - Organization patterns
- [v2.5 Changelog](v2.5.md) - Architectural consolidation

## Patch Releases

### v2.6.1

- Additional deep nesting refinements
- Enhanced error messages

### v2.6.3

- Runtime system improvements
- TypeScript definition updates

---

**Full Changelog**: https://github.com/CLDMV/slothlet/compare/v2.5.0...v2.6.0
